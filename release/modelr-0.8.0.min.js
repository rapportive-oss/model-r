/*** modelr-0.8.0.min.js ***/lib.destroyable=function(e,n){return lib.hasEvent(e,n,"destroy"),e.listenUntilDestroyed=function(n,t,r){n[n.jquery?t:"on"+lib.camelize(t)](r),e.onDestroy(function(){n[n.jquery?"unbind":"removeHandler"](t,r)})},e.chainedDestroyable=function(n){return e.onDestroy(n.triggerDestroy),n},e.chainedDeferrable=function(n){return e.onDestroy(n.reject),n},e.destroyableDiv=function(n){return n=n||jQuery("<div>"),e.onDestroy(function(){n.remove()}),n},e},lib.fillable=function(e,n,t){function r(e,n,t){return _(n).map(function(n){var r=t.apply(this,i.concat([n])),o=_(e||[]).detect(function(e){return e.identity&&e.identity===r.identity});return o?((o.refill||o.attributes)(n),o):r})}var i=_.toArray(arguments).slice(3);return!t||_.isArray(t)||"string"==typeof t?(lib.model.apply(this,arguments),e.refill=e.attributes):_.isFunction(t)?(lib.model.apply(this,[e,n].concat(i)),e.refill=t):(lib.model(e,n,_(t).keys()),e.refill=function(n){return e.transaction(function(){_(n).each(function(n,o){var a=e[o]&&(e[o].refill||e[o].attributes),u=function(){e.trigger(o+"_change",e[o])};_.isFunction(a)?(e[o].onChange(u),a.call(e[o],n),e[o].removeHandler(o+"_change",u)):_.isFunction(t[o])?e[o]=t[o].apply(this,i.concat(n)):_.isArray(t[o])&&_.isFunction(t[o][0])?e[o]=r(e[o],n,t[o][0]):"undefined"!=typeof n&&(e[o]=n)}),e.triggerChange(e)})}),e.refill},lib.hasEvent=function(e,n,t){n.event_handlers=n.event_handlers||{},e.on=e.on||function(t,r){if(!_.isFunction(r))throw new TypeError("Tried to bind "+t+" with non-function:"+String(r));return n.event_handlers[t]=n.event_handlers[t]||[],n.event_handlers[t].push(r),e},e.onceOn=e.onceOn||function(n,t){function r(){return e.removeHandler(n,r),t.apply(this,arguments)}if(!_.isFunction(t))throw new TypeError("Tried to bind "+n+" with non-function:"+String(t));return e.on(n,r)},e.nowAndOn=e.nowAndOn||function(n,t){return t.apply(e,_(arguments).toArray().slice(2)),e["on"+lib.camelize(n)](t)},e.removeHandlers=e.removeHandlers||function(e){n.event_handlers[e]=[]},e.removeHandler=e.removeHandler||function(e,t){var r=n.event_handlers[e];if(r){var i=r.indexOf(t);if(!(0>i))return r.splice(i,1)[0]}},e.trigger=e.trigger||function(t){var r=Array.prototype.slice.call(arguments,1),i=this;return n.event_handlers.hasOwnProperty(t)&&_(n.event_handlers[t]).chain().clone().each(function(e){e.apply(i,r)}),e},e.hasHandlers=e.hasHandlers||function(e){return(n.event_handlers[e]||[]).length>0},_(t).isArray()||(t=_(arguments).toArray().slice(2)),_(t).each(function(t){n.event_handlers[t]=n.event_handlers[t]||[],e["on"+lib.camelize(t)]=function(n){return e.on(t,n)},e["trigger"+lib.camelize(t)]=function(){return e.trigger.apply(this,[t].concat(_(arguments).toArray()))}})},lib.model=function(e,n,t){return n.attributes=n.attributes||{},lib.hasEvent(e,n,"change"),_(t).isArray()||(t=_(arguments).toArray().slice(2)),_(t).each(function(t){var r=t+"_change";lib.hasEvent(e,n,r),e.on(r,function(){e.transactionalTrigger("change",e)}),e.__defineGetter__(t,function(){return n.attributes[t]}),e.__defineSetter__(t,function(r){return n.setAttribute(t,r,r!==e[t])}),e["set"+lib.camelize(t)+"Later"]=function(n){e.setAttributeLater(t,n)}}),n.setAttribute=function(t,r,i){n.attributes[t]=r,i&&e.transactionalTrigger(t+"_change",r)},e.attributes=function(t){return e.transaction(function(){if("undefined"!=typeof t){var r;for(r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}return _.clone(n.attributes)})},e.unbuild=function(){var e={};return _(n.attributes).each(function(n,t){e[t]=_(n.unbuild).isFunction()?n.unbuild():n}),e},e.setAttributeLater=function(n,t){window.setTimeout(function(){e[n]=t},0)},e.bindTo=function(n,t){return e.onChange(function(){n.trigger(t+"_change",e)}),n.trigger(t+"_change",e),e},e.whenEqual=function(t,r,i){return e[t]===r?i.call(e):(n.when_equal=n.when_equal||{},n.when_equal[t]?n.when_equal[t].push({expected_value:r,callback:i}):(n.when_equal[t]=[{expected_value:r,callback:i}],e.on(t+"_change",function(r){n.when_equal[t]=_(n.when_equal[t]).reject(function(n){return n.expected_value===r?(n.callback.call(e),!0):void 0})}))),e},e.wheneverEqual=function(n,t,r){return e.nowAndOn(n+"_change",function(){e[n]===t&&r.call(e)})},e.transaction=function(t){if(n.transaction_queue)return t();n.transaction_queue=[];for(var r=t();n.transaction_queue.length;)_(n.transaction_queue.splice(0)).invoke("call");return n.transaction_queue=null,n.transaction_triggered_change&&(n.transaction_triggered_change=!1,e.triggerChange(e)),r},e.transactionalTrigger=function(){var t=this,r=arguments;n.transaction_queue?"change"===r[0]?n.transaction_triggered_change=!0:n.transaction_queue.push(function(){e.trigger.apply(t,r)}):e.trigger.apply(t,r)},n.cloneable=function(t){function r(e){if("object"!=typeof e||null===e)return e;if(_(e).isArray())return _(e).map(r);var n=_(i).detect(function(n){return n[0]===e});if(n)return n[1];var t;return"function"==typeof e.clone?t=e.clone({clone_cache:i}):(t={},i.push([e,t]),_(e).each(function(e,n){t[n]=r(e)})),t}var i;e.clone=function(o){var a=t();return i=o&&o.clone_cache||[],i.push([e,a]),_(n.attributes).each(function(e,n){a[n]=r(e)}),a}},e},lib.model.build=function(e){var n=this();return n.attributes(e),n},lib.model.class_from_attributes=function(e){var n=function(){var n={},t={};return lib.model(n,t,e),n};return n.build=lib.model.build,n},lib.model.usingEquality=function(e){return function(n,t,r){lib.model.apply(lib.model,arguments),_(r).isArray()||(r=_(arguments).toArray().slice(2)),_(r).each(function(r){n.__defineSetter__(r,function(i){return t.setAttribute(r,i,!e(i,n[r]))}),n[lib.camelize(r,!0)+"Equals"]=function(t){return e(n[r],t)}})}},lib.postMessageShim=function(e,n,t){function r(e){o&&console.log((t.name||"pmshim")+" SENT-->: "+JSON.stringify(e)),$.message(i,e,_.isFunction(t.remote_base_url)?t.remote_base_url():t.remote_base_url)}var i=t.iframe||t.window,o=!0;t.model&&(lib.model(e,n,t.model),t.receive=(t.receive||[]).concat(_(t.model).map(function(e){return e+"_sync"})),_(t.model).each(function(n){var t;e.on(n+"_sync",function(r){t=r.value,e[n]=r.value,t=void 0}),e.on(n+"_change",function(e){e!==t&&r({action:n+"_sync",rapportive:!0,value:e})})})),t.receive&&(lib.hasEvent(e,n,t.receive),$.message(i,loggily("postmessageshim.message",function(n){_(t.receive).include(n.action)?(o&&console.log((t.name||"pmshim")+" -->RECV: "+JSON.stringify(n)),e.trigger(n.action,n)):n.rapportive&&console.log((t.name||"pmshim")+" got unexpected postMessage: "+JSON.stringify(n))}))),t.send&&(lib.hasEvent(e,n,t.send),_(t.send).each(function(n){e.on(n,function(e){r(jQuery.extend({action:n,rapportive:!0},e))})}))},lib.saveable=function(e,n,t){if(!JSON)throw new Error("JSON does not exist");return e.save=function(){return lib.storage.setItem(t,JSON.stringify(e.attributes()))},e.fetch=function(){var e=lib.storage.getItem(t);return e&&(e=JSON.parse(e)),e},e.loadWithDefaults=function(n){var t=e.fetch();t?e.attributes(t):(e.attributes(n),e.save())},e.mergeNewest=function(n){var t=e.fetch();!t||!t.fetched_at||t.fetched_at<n.fetched_at?(e.attributes(n),e.save()):e.attributes(t)},e.clearStorage=function(){lib.storage.setItem(t,void 0)},e},lib.showable=function(e,n){return lib.model(e,n,"visible"),lib.destroyable(e,n),e.visible=!1,e.show=function(){return e.visible=!0,e},e.hide=function(){return e.visible=!1,e},e.toggle=function(){return e.visible=arguments.length?arguments[0]:!e.visible,e},e.onDestroy(e.hide),e},lib.showable.manager=function(){var e={},n=null;return e.manage=function(e){e.wheneverEqual("visible",!0,function(){n&&n!==e&&n.hide(),n=e}),e.wheneverEqual("visible",!1,function(){e===n&&(n=null)})},_(arguments).chain().flatten().each(e.manage),e},lib.storage=function(){function e(e,i,o,a){a=jQuery.extend({on_quota_exceeded:function(){n.setItem(e,i,{on_quota_exceeded:function(){console.log("Not writing "+e+" to localStorage: this value is too big.")}})}},a),o&&/QUOTA/.test(o.name)?(_(t).each(function(e,n){r.hasOwnProperty(n)||(r[n]=e),delete t[n]}),a.on_quota_exceeded()):console.log("Failed to write "+e+" to localStorage: "+o)}var n={},t=window.localStorage,r={};return n.getItem=function(e){if(!r.hasOwnProperty(e))try{r[e]=t[e]}catch(n){console.log("Not reading "+e+" from localStorage: "+n),r[e]=null}return r[e]},n.setItem=function(n,i,o){try{r[n]=i,t[n]=i}catch(a){e(n,i,a,o)}},n.use=function(e){t=e},n}(),function(){function e(e){return e.charAt(0).toUpperCase()+e.slice(1)}function n(e){return e.charAt(0).toLowerCase()+e.slice(1)}lib.camelize=function(t,r){var i=_(t.split(/_/)).map(function(n){return e(n)}).join("");return r?n(i):e(i)},lib.underscore=function(e){return e.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z0-9])([A-Z])/g,"$1_$2").replace(/\-/g,"_").toLowerCase()}}(),lib.view=function(e){e.remove=function(){e.$el.remove()}};