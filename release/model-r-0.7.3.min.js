/*** model-r-0.7.3.min.js ***/lib.destroyable=function(t,e){return lib.hasEvent(t,e,"destroy"),t.listenUntilDestroyed=function(e,n,r){e[e.jquery?n:"on"+lib.camelize(n)](r),t.onDestroy(function(){e[e.jquery?"unbind":"removeHandler"](n,r)})},t.chainedDestroyable=function(e){return t.onDestroy(e.triggerDestroy),e},t.chainedDeferrable=function(e){return t.onDestroy(e.reject),e},t.destroyableDiv=function(e){return e=e||jQuery("<div>"),t.onDestroy(function(){e.remove()}),e},t},lib.fillable=function(t,e,n){function r(t,e,n){return _(e).map(function(e){var r=n.apply(this,i.concat([e])),o=_(t||[]).detect(function(t){return t.identity&&t.identity===r.identity});return o?((o.refill||o.attributes)(e),o):r})}var i=_.toArray(arguments).slice(3);return!n||_.isArray(n)||"string"==typeof n?(lib.model.apply(this,arguments),t.refill=t.attributes):_.isFunction(n)?(lib.model.apply(this,[t,e].concat(i)),t.refill=n):(lib.model(t,e,_(n).keys()),t.refill=function(e){return t.transaction(function(){_(e).each(function(e,o){var a=t[o]&&(t[o].refill||t[o].attributes),s=function(){t.trigger(o+"_change",t[o])};_.isFunction(a)?(t[o].onChange(s),a.call(t[o],e),t[o].removeHandler(o+"_change",s)):_.isFunction(n[o])?t[o]=n[o].apply(this,i.concat(e)):_.isArray(n[o])&&_.isFunction(n[o][0])?t[o]=r(t[o],e,n[o][0]):"undefined"!=typeof e&&(t[o]=e)}),t.triggerChange(t)})}),t.refill},lib.hasEvent=function(t,e,n){e.event_handlers=e.event_handlers||{},t.on=t.on||function(n,r){if(!_.isFunction(r))throw new TypeError("Tried to bind "+n+" with non-function:"+String(r));return e.event_handlers[n]=e.event_handlers[n]||[],e.event_handlers[n].push(r),t},t.onceOn=t.onceOn||function(e,n){function r(){return t.removeHandler(e,r),n.apply(this,arguments)}if(!_.isFunction(n))throw new TypeError("Tried to bind "+e+" with non-function:"+String(n));return t.on(e,r)},t.nowAndOn=t.nowAndOn||function(e,n){return n.apply(t,_(arguments).toArray().slice(2)),t["on"+lib.camelize(e)](n)},t.removeHandlers=t.removeHandlers||function(t){e.event_handlers[t]=[]},t.removeHandler=t.removeHandler||function(t,n){var r=e.event_handlers[t];if(r){var i=r.indexOf(n);if(!(0>i))return r.splice(i,1)[0]}},t.trigger=t.trigger||function(n){var r=Array.prototype.slice.call(arguments,1),i=this;return e.event_handlers.hasOwnProperty(n)&&_(e.event_handlers[n]).chain().clone().each(function(t){t.apply(i,r)}),t},t.hasHandlers=t.hasHandlers||function(t){return(e.event_handlers[t]||[]).length>0},_(n).isArray()||(n=_(arguments).toArray().slice(2)),_(n).each(function(n){e.event_handlers[n]=e.event_handlers[n]||[],t["on"+lib.camelize(n)]=function(e){return t.on(n,e)},t["trigger"+lib.camelize(n)]=function(){return t.trigger.apply(this,[n].concat(_(arguments).toArray()))}})},lib.model=function(t,e,n){return e.attributes=e.attributes||{},lib.hasEvent(t,e,"change"),_(n).isArray()||(n=_(arguments).toArray().slice(2)),_(n).each(function(n){var r=n+"_change";lib.hasEvent(t,e,r),t.on(r,function(){t.transactionalTrigger("change",t)}),t.__defineGetter__(n,function(){return e.attributes[n]}),t.__defineSetter__(n,function(r){return e.setAttribute(n,r,r!==t[n])}),t["set"+lib.camelize(n)+"Later"]=function(e){t.setAttributeLater(n,e)}}),e.setAttribute=function(n,r,i){e.attributes[n]=r,i&&t.transactionalTrigger(n+"_change",r)},t.attributes=function(n){return t.transaction(function(){if("undefined"!=typeof n){var r;for(r in n)n.hasOwnProperty(r)&&(t[r]=n[r])}return _.clone(e.attributes)})},t.unbuild=function(){var t={};return _(e.attributes).each(function(e,n){t[n]=_(e.unbuild).isFunction()?e.unbuild():e}),t},t.setAttributeLater=function(e,n){window.setTimeout(function(){t[e]=n},0)},t.bindTo=function(e,n){return t.onChange(function(){e.trigger(n+"_change",t)}),e.trigger(n+"_change",t),t},t.whenEqual=function(n,r,i){return t[n]===r?i.call(t):(e.when_equal=e.when_equal||{},e.when_equal[n]?e.when_equal[n].push({expected_value:r,callback:i}):(e.when_equal[n]=[{expected_value:r,callback:i}],t.on(n+"_change",function(r){e.when_equal[n]=_(e.when_equal[n]).reject(function(e){return e.expected_value===r?(e.callback.call(t),!0):void 0})}))),t},t.wheneverEqual=function(e,n,r){return t.nowAndOn(e+"_change",function(){t[e]===n&&r.call(t)})},t.transaction=function(n){if(e.transaction_queue)return n();e.transaction_queue=[];for(var r=n();e.transaction_queue.length;)_(e.transaction_queue.splice(0)).invoke("call");return e.transaction_queue=null,e.transaction_triggered_change&&(e.transaction_triggered_change=!1,t.triggerChange(t)),r},t.transactionalTrigger=function(){var n=this,r=arguments;e.transaction_queue?"change"===r[0]?e.transaction_triggered_change=!0:e.transaction_queue.push(function(){t.trigger.apply(n,r)}):t.trigger.apply(n,r)},e.cloneable=function(n){function r(t){if("object"!=typeof t||null===t)return t;if(_(t).isArray())return _(t).map(r);var e=_(i).detect(function(e){return e[0]===t});if(e)return e[1];var n;return"function"==typeof t.clone?n=t.clone({clone_cache:i}):(n={},i.push([t,n]),_(t).each(function(t,e){n[e]=r(t)})),n}var i;t.clone=function(o){var a=n();return i=o&&o.clone_cache||[],i.push([t,a]),_(e.attributes).each(function(t,e){a[e]=r(t)}),a}},t},lib.model.build=function(t){var e=this();return e.attributes(t),e},lib.model.class_from_attributes=function(t){var e=function(){var e={},n={};return lib.model(e,n,t),e};return e.build=lib.model.build,e},lib.model.usingEquality=function(t){return function(e,n,r){lib.model.apply(lib.model,arguments),_(r).isArray()||(r=_(arguments).toArray().slice(2)),_(r).each(function(r){e.__defineSetter__(r,function(i){return n.setAttribute(r,i,!t(i,e[r]))}),e[lib.camelize(r,!0)+"Equals"]=function(n){return t(e[r],n)}})}},lib.postMessageShim=function(t,e,n){function r(t){o&&console.log((n.name||"pmshim")+" SENT-->: "+JSON.stringify(t)),$.message(i,t,_.isFunction(n.remote_base_url)?n.remote_base_url():n.remote_base_url)}var i=n.iframe||n.window,o=!0;n.model&&(lib.model(t,e,n.model),n.receive=(n.receive||[]).concat(_(n.model).map(function(t){return t+"_sync"})),_(n.model).each(function(e){var n;t.on(e+"_sync",function(r){n=r.value,t[e]=r.value,n=void 0}),t.on(e+"_change",function(t){t!==n&&r({action:e+"_sync",rapportive:!0,value:t})})})),n.receive&&(lib.hasEvent(t,e,n.receive),$.message(i,loggily("postmessageshim.message",function(e){_(n.receive).include(e.action)?(o&&console.log((n.name||"pmshim")+" -->RECV: "+JSON.stringify(e)),t.trigger(e.action,e)):e.rapportive&&console.log((n.name||"pmshim")+" got unexpected postMessage: "+JSON.stringify(e))}))),n.send&&(lib.hasEvent(t,e,n.send),_(n.send).each(function(e){t.on(e,function(t){r(jQuery.extend({action:e,rapportive:!0},t))})}))},components.RapportiveRouter=function(t){t=t||{},t.routes&&(this.routes=t.routes),this._bindRoutes()};var namedParam=/:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-\[\]{}()+?.,\\\^$|#\s]/g;_.extend(components.RapportiveRouter.prototype,{reversible_route:function(t,e){if(_.isRegExp(t)||(t=this._routeToRegExp(t)),!e.enter)throw"using reversible routing but no 'enter' function was specified.";return components.history.route(t,{enter:_.bind(function(n){var r=this._extractParameters(t,n);e.enter.apply(this,r)},this),exit:_.bind(function(n){var r=this._extractParameters(t,n);e.exit.apply(this,r)},this)}),this},sanitizeUrlBit:function(t){return t?(t=t.trim(),0===t.length||"_"===t||t===encodeURIComponent("_")?null:decodeURIComponent(t).replace(/\+/g," ")):t},routes_by_name:{},route:function(t,e,n){return this.routes_by_name[e]=t,_.isRegExp(t)||(t=this._routeToRegExp(t)),n||(n=this[e]),components.history.route(t,_.bind(function(e){var r=this._extractParameters(t,e),i=this;r=_(r).map(function(t){return i.sanitizeUrlBit(t)}),n&&n.apply(this,r)},this)),this},navigate:function(t,e){components.history.navigate(t,e)},_bindRoutes:function(){if(this.routes){var t=[];for(var e in this.routes)this.routes.hasOwnProperty(e)&&t.unshift([e,this.routes[e]]);for(var n=0,r=t.length;r>n;n+=1)this.route(t[n][0],t[n][1],this[t[n][1]])}},_routeToRegExp:function(t){return t=t.replace(escapeRegExp,"\\$&").replace(namedParam,"([^/]+)").replace(splatParam,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){return t.exec(e).slice(1)}});var History=function(){this.handlers=[],_.bindAll(this,"checkUrl")},routeStripper=/^[#\/]/,isExplorer=/msie [\w.]+/;History.started=!1,_.extend(History.prototype,{interval:50,getHash:function(t){var e=t?t.location:window.location,n=e.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(t,e){if(!t)if(this._hasPushState||e){t=window.location.pathname;var n=window.location.search;n&&(t+=n)}else t=this.getHash();return t.indexOf(this.options.root)||(t=t.substr(this.options.root.length)),t.replace(routeStripper,"")},start:function(t){if(History.started)throw new Error("History has already been started");History.started=!0,this.options=_.extend({},{root:"/"},this.options,t),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var e=this.getFragment();document.documentMode,this._hasPushState?$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window?$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=window.setInterval(this.checkUrl,this.interval)),this.fragment=e;var n=window.location,r=n.pathname===this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!r?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&r&&n.hash&&(this.fragment=this.getHash().replace(routeStripper,""),window.history.replaceState({},document.title,n.protocol+"//"+n.host+this.options.root+this.fragment)),this._wantsPushState&&this._hasPushState&&this.options.root==="/"+this.fragment+"/"&&window.history.replaceState({},document.title,n.protocol+"//"+n.host+this.options.root),this.options.silent?void 0:this.loadUrl())},stop:function(){$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),window.clearInterval(this._checkUrlInterval),History.started=!1},route:function(t,e){_.isFunction(e)?this.handlers.unshift({route:t,callback:e}):this.handlers.unshift(_.extend({route:t},e))},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this._priorUrl=this._currentUrl,this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash()))},loadUrl:function(t){var e=this;_.each(this.handlers,function(t){t.exit&&t.route.test(e._priorUrl)&&t.exit(e._priorUrl)});var n=this.fragment=this.getFragment(t),r=_.any(this.handlers,function(t){return t.route.test(n.toLowerCase())?(e._currentUrl=n,(t.enter||t.callback)(n),!0):void 0});return r},navigate:function(t,e){if(!History.started)return!1;e&&e!==!0||(e={trigger:e});var n=(t||"").replace(routeStripper,"");this.fragment!==n&&(this._hasPushState?(0!==n.indexOf(this.options.root)&&(n=this.options.root+n),this.fragment=n,window.history[e.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,e.replace),this.iframe&&n!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,e.replace))):window.location.assign(this.options.root+t),e.trigger&&this.loadUrl(t))},_updateHash:function(t,e,n){n?t.replace(t.toString().replace(/(javascript:|#).*$/,"")+"#"+e):t.hash=e}}),components.history=new History,lib.saveable=function(t,e,n){if(!JSON)throw new Error("JSON does not exist");return t.save=function(){return lib.storage.setItem(n,JSON.stringify(t.attributes()))},t.fetch=function(){var t=lib.storage.getItem(n);return t&&(t=JSON.parse(t)),t},t.loadWithDefaults=function(e){var n=t.fetch();n?t.attributes(n):(t.attributes(e),t.save())},t.mergeNewest=function(e){var n=t.fetch();!n||!n.fetched_at||n.fetched_at<e.fetched_at?(t.attributes(e),t.save()):t.attributes(n)},t.clearStorage=function(){lib.storage.setItem(n,void 0)},t},lib.showable=function(t,e){return lib.model(t,e,"visible"),lib.destroyable(t,e),t.visible=!1,t.show=function(){return t.visible=!0,t},t.hide=function(){return t.visible=!1,t},t.toggle=function(){return t.visible=arguments.length?arguments[0]:!t.visible,t},t.onDestroy(t.hide),t},lib.showable.manager=function(){var t={},e=null;return t.manage=function(t){t.wheneverEqual("visible",!0,function(){e&&e!==t&&e.hide(),e=t}),t.wheneverEqual("visible",!1,function(){t===e&&(e=null)})},_(arguments).chain().flatten().each(t.manage),t},lib.storage=function(){function t(t,i,o,a){a=jQuery.extend({on_quota_exceeded:function(){e.setItem(t,i,{on_quota_exceeded:function(){console.log("Not writing "+t+" to localStorage: this value is too big.")}})}},a),o&&/QUOTA/.test(o.name)?(_(n).each(function(t,e){r.hasOwnProperty(e)||(r[e]=t),delete n[e]}),a.on_quota_exceeded()):console.log("Failed to write "+t+" to localStorage: "+o)}var e={},n=window.localStorage,r={};return e.getItem=function(t){if(!r.hasOwnProperty(t))try{r[t]=n[t]}catch(e){console.log("Not reading "+t+" from localStorage: "+e),r[t]=null}return r[t]},e.setItem=function(e,i,o){try{r[e]=i,n[e]=i}catch(a){t(e,i,a,o)}},e.use=function(t){n=t},e}(),function(){function t(t){return t.charAt(0).toUpperCase()+t.slice(1)}function e(t){return t.charAt(0).toLowerCase()+t.slice(1)}lib.camelize=function(n,r){var i=_(n.split(/_/)).map(function(e){return t(e)}).join("");return r?e(i):t(i)},lib.underscore=function(t){return t.replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z0-9])([A-Z])/g,"$1_$2").replace(/\-/g,"_").toLowerCase()}}(),lib.view=function(t){t.remove=function(){t.$el.remove()}};