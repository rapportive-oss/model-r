/*** model-r-0.7.1.min.js ***/
lib.destroyable=function(_public,_protected){lib.hasEvent(_public,_protected,'destroy');_public.listenUntilDestroyed=function(object,event_name,handler){object[(object.jquery?event_name:'on'+lib.camelize(event_name))](handler);_public.onDestroy(function(){object[(object.jquery?'unbind':'removeHandler')](event_name,handler);});};_public.chainedDestroyable=function(destroyable){_public.onDestroy(destroyable.triggerDestroy);return destroyable;};_public.chainedDeferrable=function(deferrable){_public.onDestroy(deferrable.reject);return deferrable;};_public.destroyableDiv=function(node){node=node||jQuery('<div>');_public.onDestroy(function(){node.remove();});return node;};return _public;};lib.fillable=function(_public,_protected,spec){var remaining_arguments=_.toArray(arguments).slice(3);function mergeSetOfObjects(old_array,new_array,constructor){return _(new_array).map(function(data){var new_object=constructor.apply(this,remaining_arguments.concat([data])),existing=_(old_array||[]).detect(function(old){return old.identity&&old.identity===new_object.identity;});if(existing){(existing.refill||existing.attributes)(data);return existing;}else{return new_object;}});}
if(!spec||_.isArray(spec)||typeof(spec)==='string'){lib.model.apply(this,arguments);_public.refill=_public.attributes;}else if(_.isFunction(spec)){lib.model.apply(this,[_public,_protected].concat(remaining_arguments));_public.refill=spec;}else{lib.model(_public,_protected,_(spec).keys());_public.refill=function(attributes){return _public.transaction(function(){_(attributes).each(function(value,name){var filler=_public[name]&&(_public[name].refill||_public[name].attributes),triggerer=function(){_public.trigger(name+"_change",_public[name]);};if(_.isFunction(filler)){_public[name].onChange(triggerer);filler.call(_public[name],value);_public[name].removeHandler(name+"_change",triggerer);}else if(_.isFunction(spec[name])){_public[name]=spec[name].apply(this,remaining_arguments.concat(value));}else if(_.isArray(spec[name])&&_.isFunction(spec[name][0])){_public[name]=mergeSetOfObjects(_public[name],value,spec[name][0]);}else if(typeof value!=='undefined'){_public[name]=value;}});_public.triggerChange(_public);});};}
return _public.refill;};lib.hasEvent=function(_public,_protected,event_names){_protected.event_handlers=_protected.event_handlers||{};_public.on=_public.on||function(name,handler){if(!_.isFunction(handler)){throw new TypeError("Tried to bind "+name+" with non-function:"+String(handler));}
_protected.event_handlers[name]=_protected.event_handlers[name]||[];_protected.event_handlers[name].push(handler);return _public;};_public.onceOn=_public.onceOn||function(name,handler){if(!_.isFunction(handler)){throw new TypeError("Tried to bind "+name+" with non-function:"+String(handler));}
function onceHandler(){_public.removeHandler(name,onceHandler);return handler.apply(this,arguments);}
return _public.on(name,onceHandler);};_public.nowAndOn=_public.nowAndOn||function(name,handler){handler.apply(_public,_(arguments).toArray().slice(2));return _public["on"+lib.camelize(name)](handler);};_public.removeHandlers=_public.removeHandlers||function(name){_protected.event_handlers[name]=[];};_public.removeHandler=_public.removeHandler||function(name,handler){var handlers=_protected.event_handlers[name];if(!handlers){return;}
var index=handlers.indexOf(handler);if(index<0){return;}
return handlers.splice(index,1)[0];};_public.trigger=_public.trigger||function(name){var args=Array.prototype.slice.call(arguments,1),that=this;if(_protected.event_handlers.hasOwnProperty(name)){_(_protected.event_handlers[name]).chain().clone().each(function(handler){handler.apply(that,args);});}
return _public;};_public.hasHandlers=_public.hasHandlers||function(event_name){return(_protected.event_handlers[event_name]||[]).length>0;};if(!_(event_names).isArray()){event_names=_(arguments).toArray().slice(2);}
_(event_names).each(function(event_name){_protected.event_handlers[event_name]=_protected.event_handlers[event_name]||[];_public['on'+lib.camelize(event_name)]=function(handler){return _public.on(event_name,handler);};_public['trigger'+lib.camelize(event_name)]=function(){return _public.trigger.apply(this,[event_name].concat(_(arguments).toArray()));};});};lib.model=function(_public,_protected,declared_attributes){_protected.attributes=_protected.attributes||{};lib.hasEvent(_public,_protected,'change');if(!_(declared_attributes).isArray()){declared_attributes=_(arguments).toArray().slice(2);}
_(declared_attributes).each(function(name){var change_event_name=name+'_change';lib.hasEvent(_public,_protected,change_event_name);_public.on(change_event_name,function(new_value){_public.transactionalTrigger('change',_public);});_public.__defineGetter__(name,function(){return _protected.attributes[name];});_public.__defineSetter__(name,function(new_value){return _protected.setAttribute(name,new_value,new_value!==_public[name]);});_public['set'+lib.camelize(name)+'Later']=function(new_value){_public.setAttributeLater(name,new_value);};});_protected.setAttribute=function(name,new_value,trigger_change){_protected.attributes[name]=new_value;if(trigger_change){_public.transactionalTrigger(name+'_change',new_value);}};_public.attributes=function(new_attributes){return _public.transaction(function(){if(typeof(new_attributes)!=='undefined'){var attribute;for(attribute in new_attributes){if(new_attributes.hasOwnProperty(attribute)){_public[attribute]=new_attributes[attribute];}}}
return _.clone(_protected.attributes);});};_public.unbuild=function(){var obj={};_(_protected.attributes).each(function(attr,name){obj[name]=_(attr.unbuild).isFunction()?attr.unbuild():attr;});return obj;};_public.setAttributeLater=function(name,new_value){window.setTimeout(function(){_public[name]=new_value;},0);};_public.bindTo=function(parent,attribute){_public.onChange(function(){parent.trigger(attribute+'_change',_public);});parent.trigger(attribute+'_change',_public);return _public;};_public.whenEqual=function(name,expected_value,callback){if(_public[name]===expected_value){callback.call(_public);}else{_protected.when_equal=_protected.when_equal||{};if(_protected.when_equal[name]){_protected.when_equal[name].push({expected_value:expected_value,callback:callback});}else{_protected.when_equal[name]=[{expected_value:expected_value,callback:callback}];_public.on(name+'_change',function(new_value){_protected.when_equal[name]=_(_protected.when_equal[name]).reject(function(item){if(item.expected_value===new_value){item.callback.call(_public);return true;}});});}}
return _public;};_public.wheneverEqual=function(name,expected_value,callback){return _public.nowAndOn(name+'_change',function(){if(_public[name]===expected_value){callback.call(_public);}});};_public.transaction=function(func){if(_protected.transaction_queue){return func();}
_protected.transaction_queue=[];var ret=func();while(_protected.transaction_queue.length){_(_protected.transaction_queue.splice(0)).invoke('call');}
_protected.transaction_queue=null;if(_protected.transaction_triggered_change){_protected.transaction_triggered_change=false;_public.triggerChange(_public);}
return ret;};_public.transactionalTrigger=function(){var thiz=this,args=arguments;if(_protected.transaction_queue){if(args[0]==='change'){_protected.transaction_triggered_change=true;}else{_protected.transaction_queue.push(function(){_public.trigger.apply(thiz,args);});}}else{_public.trigger.apply(thiz,args);}};_protected.cloneable=function(model_class){var clone_cache;function deepClone(thing){if(typeof(thing)!=='object'||thing===null){return thing;}
if(_(thing).isArray()){return _(thing).map(deepClone);}
var cached=_(clone_cache).detect(function(pair){return pair[0]===thing;});if(cached){return cached[1];}
var clone;if(typeof(thing.clone)==='function'){clone=thing.clone({clone_cache:clone_cache});}else{clone={};clone_cache.push([thing,clone]);_(thing).each(function(attr,name){clone[name]=deepClone(attr);});}
return clone;}
_public.clone=function(options){var clone=model_class();clone_cache=options&&options.clone_cache||[];clone_cache.push([_public,clone]);_(_protected.attributes).each(function(attr,name){clone[name]=deepClone(attr);});return clone;};};return _public;};lib.model.build=function(attributes){var obj=this();obj.attributes(attributes);return obj;};lib.model.class_from_attributes=function(attributes){var klass=function(){var _public={},_protected={};lib.model(_public,_protected,attributes);return _public;};klass.build=lib.model.build;return klass;};lib.model.usingEquality=function(isEqual){return function(_public,_protected,declared_attributes){lib.model.apply(lib.model,arguments);if(!_(declared_attributes).isArray()){declared_attributes=_(arguments).toArray().slice(2);}
_(declared_attributes).each(function(name){_public.__defineSetter__(name,function(new_value){return _protected.setAttribute(name,new_value,!isEqual(new_value,_public[name]));});_public[lib.camelize(name,true)+'Equals']=function(other_value){return isEqual(_public[name],other_value);};});};};lib.postMessageShim=function(_public,_protected,opts){var other=opts.iframe||opts.window,debug=true;function sendMessage(msg){if(debug){console.log((opts.name||'pmshim')+" SENT-->: "+JSON.stringify(msg));}
$.message(other,msg,(_.isFunction(opts.remote_base_url)?opts.remote_base_url():opts.remote_base_url));}
if(opts.model){lib.model(_public,_protected,opts.model);opts.receive=(opts.receive||[]).concat(_(opts.model).map(function(field){return field+'_sync';}));_(opts.model).each(function(name){var syncedValue;_public.on(name+'_sync',function(value){syncedValue=value.value;_public[name]=value.value;syncedValue=undefined;});_public.on(name+'_change',function(value){if(value!==syncedValue){sendMessage({action:name+'_sync',rapportive:true,value:value});}});});}
if(opts.receive){lib.hasEvent(_public,_protected,opts.receive);$.message(other,loggily("postmessageshim.message",function(msg,reply,e){if(_(opts.receive).include(msg.action)){if(debug){console.log((opts.name||'pmshim')+" -->RECV: "+JSON.stringify(msg));}
_public.trigger(msg.action,msg);}else if(msg.rapportive){console.log((opts.name||'pmshim')+" got unexpected postMessage: "+JSON.stringify(msg));}}));}
if(opts.send){lib.hasEvent(_public,_protected,opts.send);_(opts.send).each(function(name){_public.on(name,function(msg){sendMessage(jQuery.extend({action:name,rapportive:true},msg));});});}};components.RapportiveRouter=function(options){options=options||{};if(options.routes){this.routes=options.routes;}
this._bindRoutes();};var namedParam=/:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-\[\]{}()+?.,\\\^$|#\s]/g;_.extend(components.RapportiveRouter.prototype,{reversible_route:function(route,options){if(!_.isRegExp(route)){route=this._routeToRegExp(route);}
if(!options.enter){throw"using reversible routing but no 'enter' function was specified.";}
components.history.route(route,{enter:_.bind(function(fragment){var args=this._extractParameters(route,fragment);options.enter.apply(this,args);},this),exit:_.bind(function(exiting_from_fragment){var args=this._extractParameters(route,exiting_from_fragment);options.exit.apply(this,args);},this)});return this;},sanitizeUrlBit:function(bit){if(!bit){return bit;}
bit=bit.trim();if(bit.length===0||bit==='_'||bit===encodeURIComponent('_')){return null;}
return decodeURIComponent(bit).replace(/\+/g,' ');},routes_by_name:{},route:function(route,name,callback){this.routes_by_name[name]=route;if(!_.isRegExp(route)){route=this._routeToRegExp(route);}
if(!callback){callback=this[name];}
components.history.route(route,_.bind(function(fragment){var args=this._extractParameters(route,fragment);var that=this;args=_(args).map(function(param){return that.sanitizeUrlBit(param);});if(callback){callback.apply(this,args);}},this));return this;},navigate:function(fragment,options){components.history.navigate(fragment,options);},_bindRoutes:function(){if(!this.routes){return;}
var routes=[];for(var route in this.routes){if(this.routes.hasOwnProperty(route)){routes.unshift([route,this.routes[route]]);}}
for(var i=0,l=routes.length;i<l;i+=1){this.route(routes[i][0],routes[i][1],this[routes[i][1]]);}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,'\\$&').replace(namedParam,'([^\/]+)').replace(splatParam,'(.*?)');return new RegExp('^'+route+'$');},_extractParameters:function(route,fragment){return route.exec(fragment).slice(1);}});var History=function(){this.handlers=[];_.bindAll(this,'checkUrl');};var routeStripper=/^[#\/]/;var isExplorer=/msie [\w.]+/;History.started=false;_.extend(History.prototype,{interval:50,getHash:function(windowOverride){var loc=windowOverride?windowOverride.location:window.location;var match=loc.href.match(/#(.*)$/);return match?match[1]:'';},getFragment:function(fragment,forcePushState){if(!fragment){if(this._hasPushState||forcePushState){fragment=window.location.pathname;var search=window.location.search;if(search){fragment+=search;}}else{fragment=this.getHash();}}
if(!fragment.indexOf(this.options.root)){fragment=fragment.substr(this.options.root.length);}
return fragment.replace(routeStripper,'');},start:function(options){if(History.started){throw new Error("History has already been started");}
History.started=true;this.options=_.extend({},{root:'/'},this.options,options);this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;if(this._hasPushState){$(window).bind('popstate',this.checkUrl);}else if(this._wantsHashChange&&('onhashchange'in window)){$(window).bind('hashchange',this.checkUrl);}else if(this._wantsHashChange){this._checkUrlInterval=window.setInterval(this.checkUrl,this.interval);}
this.fragment=fragment;var loc=window.location;var atRoot=loc.pathname===this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!atRoot){this.fragment=this.getFragment(null,true);window.location.replace(this.options.root+'#'+this.fragment);return true;}else if(this._wantsPushState&&this._hasPushState&&atRoot&&loc.hash){this.fragment=this.getHash().replace(routeStripper,'');window.history.replaceState({},document.title,loc.protocol+'//'+loc.host+this.options.root+this.fragment);}
if(!this.options.silent){return this.loadUrl();}},stop:function(){$(window).unbind('popstate',this.checkUrl).unbind('hashchange',this.checkUrl);window.clearInterval(this._checkUrlInterval);History.started=false;},route:function(route,callback_or_options){if(_.isFunction(callback_or_options)){this.handlers.unshift({route:route,callback:callback_or_options});}else{this.handlers.unshift(_.extend({route:route},callback_or_options));}},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe));}
if(current===this.fragment){return false;}
this._priorUrl=this._currentUrl;if(this.iframe){this.navigate(current);}
return this.loadUrl()||this.loadUrl(this.getHash());},loadUrl:function(fragmentOverride){var that=this;_.each(this.handlers,function(handler){if(handler.exit&&handler.route.test(that._priorUrl)){handler.exit(that._priorUrl);}});var fragment=this.fragment=this.getFragment(fragmentOverride);var matched=_.any(this.handlers,function(handler){if(handler.route.test(fragment.toLowerCase())){that._currentUrl=fragment;(handler.enter||handler.callback)(fragment.toLowerCase());return true;}});return matched;},navigate:function(fragment,options){if(!History.started){return false;}
if(!options||options===true){options={trigger:options};}
var frag=(fragment||'').replace(routeStripper,'');if(this.fragment===frag){return;}
if(this._hasPushState){if(frag.indexOf(this.options.root)!==0){frag=this.options.root+frag;}
this.fragment=frag;window.history[options.replace?'replaceState':'pushState']({},document.title,frag);}else if(this._wantsHashChange){this.fragment=frag;this._updateHash(window.location,frag,options.replace);if(this.iframe&&(frag!==this.getFragment(this.getHash(this.iframe)))){if(!options.replace){this.iframe.document.open().close();}
this._updateHash(this.iframe.location,frag,options.replace);}}else{window.location.assign(this.options.root+fragment);}
if(options.trigger){this.loadUrl(fragment);}},_updateHash:function(location,fragment,replace){if(replace){location.replace(location.toString().replace(/(javascript:|#).*$/,'')+'#'+fragment);}else{location.hash=fragment;}}});components.history=new History();lib.saveable=function(_public,_protected,key){if(!JSON){throw new Error("JSON does not exist");}
_public.save=function(){return lib.storage.setItem(key,JSON.stringify(_public.attributes()));};_public.fetch=function(){var data=lib.storage.getItem(key);if(data){data=JSON.parse(data);}
return data;};_public.loadWithDefaults=function(initialData){var saved=_public.fetch();if(saved){_public.attributes(saved);}else{_public.attributes(initialData);_public.save();}};_public.mergeNewest=function(timestampedData){var saved=_public.fetch();if(!saved||!saved.fetched_at||saved.fetched_at<timestampedData.fetched_at){_public.attributes(timestampedData);_public.save();}else{_public.attributes(saved);}};_public.clearStorage=function(){lib.storage.setItem(key,undefined);};return _public;};lib.showable=function(_public,_protected,manager){lib.model(_public,_protected,'visible');lib.destroyable(_public,_protected);_public.visible=false;_public.show=function(){_public.visible=true;return _public;};_public.hide=function(){_public.visible=false;return _public;};_public.toggle=function(){_public.visible=arguments.length?arguments[0]:!_public.visible;return _public;};_public.onDestroy(_public.hide);return _public;};lib.showable.manager=function(){var _public={},visible=null;_public.manage=function(showable){showable.wheneverEqual('visible',true,function(){if(visible&&visible!==showable){visible.hide();}
visible=showable;});showable.wheneverEqual('visible',false,function(){if(showable===visible){visible=null;}});};_(arguments).chain().flatten().each(_public.manage);return _public;};lib.storage=(function(){var _public={},_protected={},localStorage=window.localStorage,workingStorage={};function handleStorageError(name,value,e,opts){opts=jQuery.extend({on_quota_exceeded:function(){_public.setItem(name,value,{on_quota_exceeded:function(){console.log("Not writing "+name+" to localStorage: this value is too big.");}});}},opts);if(e&&/QUOTA/.test(e.name)){_(localStorage).each(function(value,name){if(!workingStorage.hasOwnProperty(name)){workingStorage[name]=value;}
delete localStorage[name];});opts.on_quota_exceeded();}else{console.log("Failed to write "+name+" to localStorage: "+e);}}
_public.getItem=function(name){if(!workingStorage.hasOwnProperty(name)){try{workingStorage[name]=localStorage[name];}catch(e){console.log("Not reading "+name+" from localStorage: "+e);workingStorage[name]=null;}}
return workingStorage[name];};_public.setItem=function(name,value,opts){try{workingStorage[name]=value;localStorage[name]=value;}catch(e){handleStorageError(name,value,e,opts);}};_public.use=function(storage){localStorage=storage;};return _public;}());(function(){function capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);}
function uncapitalize(str){return str.charAt(0).toLowerCase()+str.slice(1);}
lib.camelize=function(str,first_letter_lowercase){var camelized=_(str.split(/_/)).map(function(word){return capitalize(word);}).join('');return(first_letter_lowercase?uncapitalize(camelized):capitalize(camelized));};lib.underscore=function(str){return str.replace(/([A-Z]+)([A-Z][a-z])/g,'$1_$2').replace(/([a-z0-9])([A-Z])/g,'$1_$2').replace(/\-/g,'_').toLowerCase();};}());lib.view=function(_public,_protected,element_type){_public.remove=function(){_public.$el.remove();};};